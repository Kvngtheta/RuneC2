name: RuneC2 CI/CD

permissions:
  actions: read
  contents: read
  security-events: write
  
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-make
          mingw-w64-ucrt-x86_64-cmake
          
    - name: Build Agent
      shell: msys2 {0}
      run: |
        g++ -std=c++14 agent.cpp myfunctions.cpp agent-functions.cpp -o agent.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Build Satellite
      shell: msys2 {0}
      run: |
        g++ -std=c++14 satellite.cpp myfunctions.cpp agent-functions.cpp -o satellite.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Build Server
      shell: msys2 {0}
      run: |
        cd other
        g++ -std=c++14 server.cpp -o server.exe -lws2_32 -liphlpapi -lcrypt32
        cd ..
        
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: runec2-windows
        path: |
          agent.exe
          satellite.exe
          other/server.exe
        retention-days: 30

  windows-analysis:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cppcheck
          mingw-w64-ucrt-x86_64-clang
          
    - name: Run Windows-specific code analysis
      shell: msys2 {0}
      run: |
        # Check for Windows API usage and potential issues
        cppcheck --enable=all --std=c++14 --platform=win64 --error-exitcode=1 \
          --suppress=missingIncludeSystem --suppress=unmatchedSuppression \
          --check-config *.cpp *.h other/*.cpp
        
    - name: Verify Windows libraries are linked correctly
      shell: msys2 {0}
      run: |
        # Test compilation with verbose output to verify Windows libs
        g++ -std=c++14 -v agent.cpp myfunctions.cpp agent-functions.cpp -o test-agent.exe -lws2_32 -liphlpapi -lcrypt32
        g++ -std=c++14 -v satellite.cpp myfunctions.cpp agent-functions.cpp -o test-satellite.exe -lws2_32 -liphlpapi -lcrypt32

  security-scan:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW for CodeQL
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: mingw-w64-ucrt-x86_64-gcc
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v4
      with:
        languages: cpp
        version: 4.31.3
        
    - name: Build for Windows security analysis
      shell: msys2 {0}
      run: |
        g++ -std=c++14 agent.cpp myfunctions.cpp agent-functions.cpp -o agent.exe -lws2_32 -liphlpapi -lcrypt32
        g++ -std=c++14 satellite.cpp myfunctions.cpp agent-functions.cpp -o satellite.exe -lws2_32 -liphlpapi -lcrypt32
        cd other && g++ -std=c++14 server.cpp -o server.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  create-release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build-windows, windows-analysis]
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: runec2-windows
        path: ./windows-build/
        
    - name: Create Windows release archive
      shell: pwsh
      run: |
        Compress-Archive -Path ./windows-build/* -DestinationPath ./runec2-windows.zip
        
    - name: Generate release tag
      shell: pwsh
      run: |
        $TAG = "v$(Get-Date -Format 'yyyyMMdd')-$($env:GITHUB_SHA.Substring(0,7))"
        echo "tag=$TAG" >> $env:GITHUB_OUTPUT
      id: tag
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: RuneC2 Windows Release ${{ steps.tag.outputs.tag }}
        body: |
          ## RuneC2 Windows-Native Release
          
          Built from commit: ${{ github.sha }}
          
          ### Components:
          - **agent.exe**: Windows C2 agent with WinAPI integration
          - **satellite.exe**: Satellite server for Windows agent management  
          - **server.exe**: Team server for satellite coordination
          
          ### Requirements:
          - Windows 7 SP1 or later
          - Administrator privileges recommended for full functionality
          
          ### Windows-Specific Features:
          - Native Windows Socket (Winsock2) implementation
          - Windows Cryptography API integration
          - IP Helper API for network enumeration
          
          ### Usage:
          1. Download runec2-windows.zip
          2. Extract files to desired directory
          3. Run executables with appropriate permissions
          4. Configure Windows Firewall as needed
          
        files: runec2-windows.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
