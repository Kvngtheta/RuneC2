name: RuneC2 CI/CD

permissions:
  actions: read
  contents: read
  security-events: write
  
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-make
          mingw-w64-ucrt-x86_64-cmake
          
    - name: Build Agent
      shell: msys2 {0}
      run: |
        g++ -std=c++14 agent.cpp myfunctions.cpp agent-functions.cpp -o agent.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Build Satellite
      shell: msys2 {0}
      run: |
        g++ -std=c++14 satellite.cpp myfunctions.cpp agent-functions.cpp -o satellite.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Build Server
      shell: msys2 {0}
      run: |
        cd other
        g++ -std=c++14 server.cpp -o server.exe -lws2_32 -liphlpapi -lcrypt32
        cd ..
        
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: runec2-windows
        path: |
          agent.exe
          satellite.exe
          other/server.exe
        retention-days: 30

  windows-analysis:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cppcheck
          mingw-w64-ucrt-x86_64-clang
          
    - name: Run Windows-specific code analysis
      shell: msys2 {0}
      run: |
        # Check for Windows API usage and potential issues
        cppcheck --enable=all --std=c++14 --platform=win64 --error-exitcode=1 \
          --suppress=missingIncludeSystem --suppress=unmatchedSuppression \
          --check-config *.cpp *.h other/*.cpp
        
    - name: Verify Windows libraries are linked correctly
      shell: msys2 {0}
      run: |
        # Test compilation with verbose output to verify Windows libs
        g++ -std=c++14 -v agent.cpp myfunctions.cpp agent-functions.cpp -o test-agent.exe -lws2_32 -liphlpapi -lcrypt32
        g++ -std=c++14 -v satellite.cpp myfunctions.cpp agent-functions.cpp -o test-satellite.exe -lws2_32 -liphlpapi -lcrypt32

  security-scan:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW for CodeQL
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: mingw-w64-ucrt-x86_64-gcc
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
       # version: 4.31.3
        
    - name: Build for Windows security analysis
      shell: msys2 {0}
      run: |
        g++ -std=c++14 agent.cpp myfunctions.cpp agent-functions.cpp -o agent.exe -lws2_32 -liphlpapi -lcrypt32
        g++ -std=c++14 satellite.cpp myfunctions.cpp agent-functions.cpp -o satellite.exe -lws2_32 -liphlpapi -lcrypt32
        cd other && g++ -std=c++14 server.cpp -o server.exe -lws2_32 -liphlpapi -lcrypt32
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
